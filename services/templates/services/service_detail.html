{% load static %}
{% load socialaccount %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ service.title }} â€“ Kerala Services</title>

  <link rel="stylesheet" href="{% static 'services/universal.css' %}">
  <script defer src="{% static 'services/homepage.js' %}"></script>
</head>

<body>

<header class="site-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="logo-circle">KS</div>
      <div class="site-title">Kerala Services</div>
    </div>

    <div class="header-right">
      <div class="search-wrapper">
        <input id="service-search" type="search" placeholder="Search for services or officesâ€¦" autocomplete="off">
        <button id="search-btn" type="button">Search</button>
        <ul id="suggestions"></ul>
      </div>
      <button id="theme-toggle" class="theme-btn">ğŸŒ™</button>
    </div>
  </div>
</header>

<main class="page-wrapper">

  <div class="breadcrumb">
    <a href="{% url 'home' %}">Home</a> â€º
    <a href="{% url 'office_detail' service.office.id %}">{{ service.office.office_name }}</a> â€º
    <span>{{ service.title }}</span>
  </div>

  <div class="top-banner">
    <h1>{{ service.title }}</h1>
    <p>{{ service.office.office_name }}</p>

<!-- SAVE BUTTON -->
<div class="save-service-container">
  {% if user.is_authenticated %}
    <button id="save-btn" data-id="{{ service.id }}" class="save-btn-cream">
      {% if is_saved %}âœ” Saved{% else %}Save Service{% endif %}
    </button>
  {% else %}
    <a href="{% provider_login_url 'google' %}?next={{ request.path }}" class="save-btn-cream">
      Save Service
    </a>
  {% endif %}
</div>
<!-- END SAVE BUTTON -->

  </div>

  <div class="info-box">

    <h2>About this service</h2>
    <p>{{ service.description|default:"No description available." }}</p>

    <div class="pill-container">

      <div class="pill pill--offline/online">
        <span class="pill-icon">
          {% if service.service_type == "Online" %}
            ğŸŒ
          {% elif service.service_type == "Offline" %}
            ğŸ¢
          {% else %}
            ğŸ”„
          {% endif %}
        </span>
        {{ service.service_type|default:"Method not specified" }}
      </div>

      <div class="pill pill--time">
        <span class="pill-icon">â±</span>
        {{ service.processing_time|default:"Processing time not specified" }}
      </div>

      <div class="pill pill--validity">
        <span class="pill-icon">
          {% if service.validity %} ğŸ“… {% else %} â“ {% endif %}
        </span>
        {{ service.validity|default:"Validity not specified" }}
      </div>

    </div>
  </div>

  {% if documents %}
  <h2 class="section-title">Required Documents</h2>
  <div class="info-box">
    {% for d in documents %}
      <div class="document-item">ğŸ“„ {{ d }}</div>
    {% endfor %}
  </div>
  {% endif %}

  {% if photos %}
  <h2 class="section-title">Sample Forms & Images</h2>
  <div class="photo-grid">
    {% for p in photos %}
      <img src="{{ p.photo_url }}" class="service-photo-thumb"
           onclick="openPhotoModal('{{ p.photo_url }}')">
    {% endfor %}
  </div>
  {% endif %}

</main>

<!-- PHOTO MODAL -->
<div id="photo-modal" onclick="closePhotoModal()">
  <img id="modal-img" alt="Preview">
</div>

<script>
// Photo Modal
function openPhotoModal(url){
  document.getElementById('modal-img').src = url;
  document.getElementById('photo-modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closePhotoModal(){
  document.getElementById('photo-modal').style.display = 'none';
  document.getElementById('modal-img').src = '';
  document.body.style.overflow = '';
}

// CSRF helper for AJAX
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Save / Unsave via AJAX
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("save-btn");
    if (!btn) return;

    btn.addEventListener("click", async () => {
        const serviceId = btn.dataset.id;
        const isSaved = btn.textContent.includes("Saved");
        const url = isSaved ? `/unsave/${serviceId}/` : `/save/${serviceId}/`;

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie('csrftoken'),
                    "Accept": "application/json",
                },
            });
            const data = await response.json();
            if (data.status === "saved") btn.textContent = "âœ” Saved";
            else if (data.status === "removed") btn.textContent = "Save Service";
        } catch (err) {
            console.error(err);
        }
    });
});
</script>

<footer>
  Â© 2025 Community Service Hub â€“ Kerala
</footer>

</body>
</html>